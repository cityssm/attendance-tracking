"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{var e,s;const t=exports.Attend;let n=exports.users;delete exports.users;const a=null!==(e=exports.userDomain)&&void 0!==e?e:"",i=exports.availablePermissionValues;delete exports.availablePermissionValues;const l=document.querySelector("#tbody--users");function o(e){var s;e.preventDefault();const a=e.currentTarget.closest("tr"),i=null!==(s=a.dataset.userName)&&void 0!==s?s:"";bulmaJS.confirm({title:"Delete User",message:`Are you sure you want to delete ${i}?<br />\n        Note that if this is temporary, revoking log in permissions would be easier to restore.`,messageIsHtml:!0,contextualColorName:"warning",okButton:{text:"Yes, Delete User",callbackFunction:function(){cityssm.postJSON(`${t.urlPrefix}/admin/doDeleteUser`,{userName:i},e=>{const s=e;s.success&&(bulmaJS.alert({message:"User deleted successfully.",contextualColorName:"success"}),a.remove()),n=s.users})}}})}function r(e){var s;e.preventDefault();const a=e.currentTarget,i=null!==(s=a.closest("tr").dataset.userName)&&void 0!==s?s:"";cityssm.postJSON(`${t.urlPrefix}/admin/doUpdateUserCanLogin`,{userName:i,canLogin:a.value},e=>{var s,t,i;const l=e;l.success?((null===(s=a.closest(".control"))||void 0===s?void 0:s.querySelector(".icon")).innerHTML=`<i class="fas ${"1"===a.value?"fa-check":"fa-times"}" aria-hidden="true"></i>`,null===(t=a.closest(".select"))||void 0===t||t.classList.remove("is-danger","is-success"),null===(i=a.closest(".select"))||void 0===i||i.classList.add("1"===a.value?"is-success":"is-danger")):bulmaJS.alert({title:"Error Updating Permission",message:"Please try again.",contextualColorName:"danger"}),n=l.users})}function c(e){var s;e.preventDefault();const a=e.currentTarget,i=null!==(s=a.closest("tr").dataset.userName)&&void 0!==s?s:"";cityssm.postJSON(`${t.urlPrefix}/admin/doUpdateUserIsAdmin`,{userName:i,isAdmin:a.value},e=>{var s,t,i;const l=e;l.success?((null===(s=a.closest(".control"))||void 0===s?void 0:s.querySelector(".icon")).innerHTML=`<i class="fas ${"1"===a.value?"fa-check":"fa-times"}" aria-hidden="true"></i>`,null===(t=a.closest(".select"))||void 0===t||t.classList.remove("is-danger","is-success"),null===(i=a.closest(".select"))||void 0===i||i.classList.add("1"===a.value?"is-success":"is-danger")):bulmaJS.alert({title:"Error Updating Permission",message:"Please try again.",contextualColorName:"danger"}),n=l.users})}function d(e){e.preventDefault();const s=e.currentTarget.closest("tr");cityssm.postJSON(`${t.urlPrefix}/admin/doSetUserPermission`,e.currentTarget,e=>{e.success?(bulmaJS.alert({message:"Permission updated successfully.",contextualColorName:"success"}),s.classList.remove("has-background-warning-light")):bulmaJS.alert({title:"Error Updating Permission",message:"Please try again.",contextualColorName:"danger"})})}function u(e){var s;null===(s=e.currentTarget.closest("tr"))||void 0===s||s.classList.add("has-background-warning-light")}function m(e){var s;let n;e.preventDefault();const a=e.currentTarget,l=null!==(s=a.closest("tr").dataset.userName)&&void 0!==s?s:"";cityssm.openHtmlModal("userAdmin-userPermissions",{onshow(e){cityssm.enableNavBlocker(),n=e,e.querySelector(".modal-card-title").textContent=l,function(){var e;const s=n.querySelector("tbody");let a=0;for(const[t,n]of Object.entries(i)){const i=document.createElement("tr");let o;switch(i.dataset.permissionKey=t,t.slice(t.lastIndexOf(".")+1)){case"canView":o="fa-eye";break;case"canUpdate":o="fa-pencil-alt";break;case"canManage":o="fa-tools";break;default:o="fa-cog"}const r=`permissionValue_${(a+=1).toString()}`;i.innerHTML=`<td class="is-vcentered">\n          <label for="${r}">\n            ${t}\n          </label>\n          </td>\n          <td>\n            <form>\n              <input name="userName" value="${l}" type="hidden" />\n              <input name="permissionKey" value="${t}" type="hidden" />\n              <div class="field has-addons">\n                <div class="control has-icons-left is-expanded">\n                  <div class="select is-fullwidth">\n                    <select id="${r}" name="permissionValue">\n                      <option value="">(Not Set)</option>\n                    </select>\n                  </div>\n                  <span class="icon is-left">\n                    <i class="fas ${o}" aria-hidden="true"></i>\n                  </span>\n                </div>\n                <div class="control">\n                  <button class="button is-success" type="submit" aria-label="Save Changes">\n                    <i class="fas fa-save" aria-hidden="true"></i>\n                  </button>\n                </div>\n              </div>\n            </form>\n          </td>`;const c=i.querySelector("select");for(const e of n)c.insertAdjacentHTML("beforeend",`<option value="${e}">${e}</option>`);c.addEventListener("change",u),null===(e=i.querySelector("form"))||void 0===e||e.addEventListener("submit",d),s.append(i)}cityssm.postJSON(`${t.urlPrefix}/admin/doGetUserPermissions`,{userName:l},e=>{var t,n;const a=e;let i=0;for(const[e,n]of Object.entries(a.userPermissions)){const a=s.querySelector(`tr[data-permission-key="${e}"]`);if(null===a){const a=`form--permissionValue-${(i+=1).toString()}`;s.insertAdjacentHTML("beforeend",`<tr data-permission-key="${e}">\n                    <td class="is-vcentered is-italic">${e}</td>\n                    <td>\n                      <form id="${a}">\n                        <input name="userName" value="${l}" type="hidden" />\n                        <input name="permissionKey" value="${e}" type="hidden" />\n                        <div class="field has-addons">\n                          <div class="control is-expanded">\n                            <div class="select is-fullwidth">\n                              <select name="permissionValue">\n                                <option value="">(Not Set)</option>\n                                <option value="${n}" selected>${n}</option>\n                              </select>\n                            </div>\n                          </div>\n                          <div class="control">\n                            <button class="button is-success" type="submit">\n                              <i class="fas fa-save" aria-hidden="true"></i>\n                            </button>\n                          </div>\n                        </div>\n                      </form>\n                    </td>\n                  </tr>`),null===(t=s.querySelector(`#${a}`))||void 0===t||t.addEventListener("submit",d)}else{const e=a.querySelector("select");null===e.querySelector(`option[value="${n}"]`)&&e.insertAdjacentHTML("beforeend",`<option>${n}</option>`),e.value=n}}null===(n=s.closest("table"))||void 0===n||n.classList.remove("is-hidden")})}()},onshown(){a.blur(),bulmaJS.toggleHtmlClipped()},onremoved(){bulmaJS.toggleHtmlClipped(),cityssm.disableNavBlocker(),a.focus()}})}function v(){var e,s,t,a,i,d,u;l.innerHTML="";for(const v of n){const n=document.createElement("tr");n.dataset.userName=v.userName,n.innerHTML=`<td class="is-vcentered">\n          ${v.userName}\n            ${""===(null!==(e=v.employeeSurname)&&void 0!==e?e:"")?"":`<br />\n                  <span class="is-size-7 has-tooltip-right" data-tooltip="Employee">\n                  <i class="fas fa-hard-hat" aria-hidden="true"></i> ${null!==(s=v.employeeSurname)&&void 0!==s?s:""}, ${null!==(t=v.employeeGivenName)&&void 0!==t?t:""}\n                  </span>`}\n        </td>\n        <td>\n          <div class="control has-icons-left">\n            <div class="select ${v.canLogin?"is-success":"is-danger"}">\n              <select data-field="canLogin" aria-label="Can Login">\n                <option value="1" ${v.canLogin?" selected":""}>\n                  Can Log In\n                </option>\n                <option value="0" ${v.canLogin?"":" selected"}>\n                  Access Denied\n                </option>\n              </select>\n            </div>\n            <span class="icon is-small is-left">\n              <i class="fas ${v.canLogin?"fa-check":"fa-times"}" aria-hidden="true"></i>\n            </span>\n          </div>\n        </td>\n        <td>\n          <div class="control has-icons-left">\n            <div class="select ${v.isAdmin?"is-success":"is-danger"}">\n              <select data-field="isAdmin" aria-label="Is Administrator">\n                <option value="0" ${v.isAdmin?"":" selected"}>\n                  No Admin Access\n                </option>\n                <option value="1" ${v.isAdmin?" selected":""}>\n                  Administrator\n                </option>\n              </select>\n            </div>\n            <span class="icon is-small is-left">\n              <i class="fas ${v.isAdmin?"fa-check":"fa-times"}" aria-hidden="true"></i>\n            </span>\n          </div>\n        </td>\n        <td class="has-width-1 has-text-centered">\n          <button class="button is-user-permissions-button" data-cy="permissions" type="button">\n            <span class="icon is-small"><i class="fas fa-th-list" aria-hidden="true"></i></span>\n            <span>Permissions</span>\n          </button>\n        </td>\n        <td class="has-width-1">\n          <button class="button is-danger is-delete-button" data-cy="delete" type="button" aria-label="Delete">\n            <span class="icon is-small"><i class="fas fa-trash" aria-hidden="true"></i></span>\n          </button>\n        </td>`,null===(a=n.querySelector('select[data-field="canLogin"]'))||void 0===a||a.addEventListener("change",r),null===(i=n.querySelector('select[data-field="isAdmin"]'))||void 0===i||i.addEventListener("change",c),null===(d=n.querySelector(".is-user-permissions-button"))||void 0===d||d.addEventListener("click",m),null===(u=n.querySelector(".is-delete-button"))||void 0===u||u.addEventListener("click",o),l.append(n)}}null===(s=document.querySelector(".is-add-user-button"))||void 0===s||s.addEventListener("click",()=>{let e;function s(s){s.preventDefault(),cityssm.postJSON(`${t.urlPrefix}/admin/doAddUser`,s.currentTarget,s=>{const t=s;t.success?(e(),bulmaJS.alert({message:"User added successfully.",contextualColorName:"success"}),n=t.users,v()):bulmaJS.alert({title:"Error Adding User",message:"Please ensure the user does not already have access, then try again.",contextualColorName:"danger"})})}cityssm.openHtmlModal("userAdmin-addUser",{onshow(e){e.querySelector("#userAdd--userDomain").textContent=`${a}\\`},onshown(t,n){var a;e=n,bulmaJS.toggleHtmlClipped();const i=t.querySelector("#userAdd--userName");i.value="",i.focus(),null===(a=t.querySelector("form"))||void 0===a||a.addEventListener("submit",s)},onremoved(){bulmaJS.toggleHtmlClipped()}})}),v()})();