"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{var e,s;const n=exports.Attend;let t=exports.users;delete exports.users;const a=null!==(e=exports.userDomain)&&void 0!==e?e:"",i=exports.availablePermissionValues;delete exports.availablePermissionValues;const l=document.querySelector("#tbody--users"),o=document.querySelector("#filter--canLogin");function r(e){var s;e.preventDefault();const a=e.currentTarget.closest("tr"),i=null!==(s=a.dataset.userName)&&void 0!==s?s:"";bulmaJS.confirm({title:"Delete User",message:`Are you sure you want to delete ${i}?<br />\n        Note that if this is temporary, revoking log in permissions would be easier to restore.`,messageIsHtml:!0,contextualColorName:"warning",okButton:{text:"Yes, Delete User",callbackFunction:function(){cityssm.postJSON(`${n.urlPrefix}/admin/doDeleteUser`,{userName:i},e=>{const s=e;s.success&&(bulmaJS.alert({message:"User deleted successfully.",contextualColorName:"success"}),a.remove()),t=s.users})}}})}function c(e){var s;e.preventDefault();const a=e.currentTarget,i=null!==(s=a.closest("tr").dataset.userName)&&void 0!==s?s:"";cityssm.postJSON(`${n.urlPrefix}/admin/doUpdateUserCanLogin`,{userName:i,canLogin:a.value},e=>{var s,n,i;const l=e;l.success?((null===(s=a.closest(".control"))||void 0===s?void 0:s.querySelector(".icon")).innerHTML=`<i class="fas ${"1"===a.value?"fa-check":"fa-times"}" aria-hidden="true"></i>`,null===(n=a.closest(".select"))||void 0===n||n.classList.remove("is-danger","is-success"),null===(i=a.closest(".select"))||void 0===i||i.classList.add("1"===a.value?"is-success":"is-danger")):bulmaJS.alert({title:"Error Updating Permission",message:"Please try again.",contextualColorName:"danger"}),t=l.users})}function d(e){var s;e.preventDefault();const a=e.currentTarget,i=null!==(s=a.closest("tr").dataset.userName)&&void 0!==s?s:"";cityssm.postJSON(`${n.urlPrefix}/admin/doUpdateUserIsAdmin`,{userName:i,isAdmin:a.value},e=>{var s,n,i;const l=e;l.success?((null===(s=a.closest(".control"))||void 0===s?void 0:s.querySelector(".icon")).innerHTML=`<i class="fas ${"1"===a.value?"fa-check":"fa-times"}" aria-hidden="true"></i>`,null===(n=a.closest(".select"))||void 0===n||n.classList.remove("is-danger","is-success"),null===(i=a.closest(".select"))||void 0===i||i.classList.add("1"===a.value?"is-success":"is-danger")):bulmaJS.alert({title:"Error Updating Permission",message:"Please try again.",contextualColorName:"danger"}),t=l.users})}function u(e){e.preventDefault();const s=e.currentTarget.closest("tr");cityssm.postJSON(`${n.urlPrefix}/admin/doSetUserPermission`,e.currentTarget,e=>{const n=e;n.success?(bulmaJS.alert({message:"Permission updated successfully.",contextualColorName:"success"}),s.classList.remove("has-background-warning-light")):bulmaJS.alert({title:"Error Updating Permission",message:"Please try again.",contextualColorName:"danger"}),t=n.users,p()})}function m(e){var s;null===(s=e.currentTarget.closest("tr"))||void 0===s||s.classList.add("has-background-warning-light")}function v(e){var s;let a,l;e.preventDefault();const o=e.currentTarget,r=null!==(s=o.closest("tr").dataset.userName)&&void 0!==s?s:"";function c(e){e.preventDefault(),bulmaJS.confirm({title:"Clear All Permissions",message:`Are you sure you want to clear all of the permissions associated with "${r}"?`,contextualColorName:"warning",okButton:{text:"Yes, Clear All Permissions",callbackFunction:function(){cityssm.postJSON(`${n.urlPrefix}/admin/doClearUserPermissions`,{userName:r},e=>{const s=e;s.success?(bulmaJS.alert({message:"Permissions cleared successfully.",contextualColorName:"info"}),l()):bulmaJS.alert({title:"Error Clearing Permissions",message:"Please try again.",contextualColorName:"danger"}),t=s.users,p()})}}})}cityssm.openHtmlModal("userAdmin-userPermissions",{onshow(e){cityssm.enableNavBlocker(),a=e,e.querySelector(".modal-card-title").textContent=r,function(){var e;const s=a.querySelector("tbody");let t=0;for(const[n,a]of Object.entries(i)){const i=document.createElement("tr");let l;switch(i.dataset.permissionKey=n,n.slice(n.lastIndexOf(".")+1)){case"canView":l="fa-eye";break;case"canUpdate":l="fa-pencil-alt";break;case"canManage":l="fa-tools";break;default:l="fa-cog"}const o=`permissionValue_${(t+=1).toString()}`;i.innerHTML=`<td class="is-vcentered">\n          <label for="${o}">\n            ${n}\n          </label>\n          </td>\n          <td>\n            <form>\n              <input name="userName" value="${r}" type="hidden" />\n              <input name="permissionKey" value="${n}" type="hidden" />\n              <div class="field has-addons">\n                <div class="control has-icons-left is-expanded">\n                  <div class="select is-fullwidth">\n                    <select id="${o}" name="permissionValue">\n                      <option value="">(Not Set)</option>\n                    </select>\n                  </div>\n                  <span class="icon is-left">\n                    <i class="fas ${l}" aria-hidden="true"></i>\n                  </span>\n                </div>\n                <div class="control">\n                  <button class="button is-success" type="submit" aria-label="Save Changes">\n                    <i class="fas fa-save" aria-hidden="true"></i>\n                  </button>\n                </div>\n              </div>\n            </form>\n          </td>`;const c=i.querySelector("select");for(const e of a)c.insertAdjacentHTML("beforeend",`<option value="${e}">${e}</option>`);c.addEventListener("change",m),null===(e=i.querySelector("form"))||void 0===e||e.addEventListener("submit",u),s.append(i)}cityssm.postJSON(`${n.urlPrefix}/admin/doGetUserPermissions`,{userName:r},e=>{var n,t;const a=e;let i=0;for(const[e,t]of Object.entries(a.userPermissions)){const a=s.querySelector(`tr[data-permission-key="${e}"]`);if(null===a){const a=`form--permissionValue-${(i+=1).toString()}`;s.insertAdjacentHTML("beforeend",`<tr data-permission-key="${e}">\n                    <td class="is-vcentered is-italic">${e}</td>\n                    <td>\n                      <form id="${a}">\n                        <input name="userName" value="${r}" type="hidden" />\n                        <input name="permissionKey" value="${e}" type="hidden" />\n                        <div class="field has-addons">\n                          <div class="control is-expanded">\n                            <div class="select is-fullwidth">\n                              <select name="permissionValue">\n                                <option value="">(Not Set)</option>\n                                <option value="${t}" selected>${t}</option>\n                              </select>\n                            </div>\n                          </div>\n                          <div class="control">\n                            <button class="button is-success" type="submit">\n                              <i class="fas fa-save" aria-hidden="true"></i>\n                            </button>\n                          </div>\n                        </div>\n                      </form>\n                    </td>\n                  </tr>`),null===(n=s.querySelector(`#${a}`))||void 0===n||n.addEventListener("submit",u)}else{const e=a.querySelector("select");null===e.querySelector(`option[value="${t}"]`)&&e.insertAdjacentHTML("beforeend",`<option>${t}</option>`),e.value=t}}null===(t=s.closest("table"))||void 0===t||t.classList.remove("is-hidden")})}()},onshown(e,s){var n;l=s,bulmaJS.init(e),o.blur(),bulmaJS.toggleHtmlClipped(),null===(n=e.querySelector(".is-clear-permissions-button"))||void 0===n||n.addEventListener("click",c)},onremoved(){bulmaJS.toggleHtmlClipped(),cityssm.disableNavBlocker(),o.focus()}})}function p(){var e,s,n,a,i,u,m,p;l.innerHTML="";for(const f of t){if(o.checked&&!f.canLogin)continue;const t=document.createElement("tr");t.dataset.userName=f.userName,t.innerHTML=`<td class="is-vcentered">\n          ${f.userName}\n            ${""===(null!==(e=f.employeeSurname)&&void 0!==e?e:"")?"":`<br />\n                  <span class="is-size-7 has-tooltip-right" data-tooltip="Employee">\n                  <i class="fas fa-hard-hat" aria-hidden="true"></i> ${null!==(s=f.employeeSurname)&&void 0!==s?s:""}, ${null!==(n=f.employeeGivenName)&&void 0!==n?n:""}\n                  </span>`}\n        </td>\n        <td>\n          <div class="control has-icons-left">\n            <div class="select ${f.canLogin?"is-success":"is-danger"}">\n              <select data-field="canLogin" aria-label="Can Login">\n                <option value="1" ${f.canLogin?" selected":""}>\n                  Can Log In\n                </option>\n                <option value="0" ${f.canLogin?"":" selected"}>\n                  Access Denied\n                </option>\n              </select>\n            </div>\n            <span class="icon is-small is-left">\n              <i class="fas ${f.canLogin?"fa-check":"fa-times"}" aria-hidden="true"></i>\n            </span>\n          </div>\n        </td>\n        <td>\n          <div class="control has-icons-left">\n            <div class="select ${f.isAdmin?"is-success":"is-danger"}">\n              <select data-field="isAdmin" aria-label="Is Administrator">\n                <option value="0" ${f.isAdmin?"":" selected"}>\n                  No Admin Access\n                </option>\n                <option value="1" ${f.isAdmin?" selected":""}>\n                  Administrator\n                </option>\n              </select>\n            </div>\n            <span class="icon is-small is-left">\n              <i class="fas ${f.isAdmin?"fa-check":"fa-times"}" aria-hidden="true"></i>\n            </span>\n          </div>\n        </td>\n        <td class="has-width-1 has-text-centered">\n          <button class="button is-user-permissions-button" data-cy="permissions" type="button">\n            <span class="icon is-small">\n              <span class="fa-layers fa-fw">\n                <i class="fas fa-th-list" aria-hidden="true"></i>\n                ${(null!==(a=f.permissionCount)&&void 0!==a?a:0)>0?`<span class="fa-layers-counter has-background-info">${f.permissionCount}</span>`:""}\n              </span>\n            </span>\n            <span>Permissions</span>\n          </button>\n        </td>\n        <td class="has-width-1">\n          <button class="button is-danger is-delete-button" data-cy="delete" type="button" aria-label="Delete">\n            <i class="fas fa-trash" aria-hidden="true"></i>\n          </button>\n        </td>`,null===(i=t.querySelector('select[data-field="canLogin"]'))||void 0===i||i.addEventListener("change",c),null===(u=t.querySelector('select[data-field="isAdmin"]'))||void 0===u||u.addEventListener("change",d),null===(m=t.querySelector(".is-user-permissions-button"))||void 0===m||m.addEventListener("click",v),null===(p=t.querySelector(".is-delete-button"))||void 0===p||p.addEventListener("click",r),l.append(t)}}o.addEventListener("click",p),null===(s=document.querySelector(".is-add-user-button"))||void 0===s||s.addEventListener("click",()=>{let e;function s(s){s.preventDefault(),cityssm.postJSON(`${n.urlPrefix}/admin/doAddUser`,s.currentTarget,s=>{const n=s;n.success?(e(),bulmaJS.alert({message:"User added successfully.",contextualColorName:"success"}),t=n.users,p()):bulmaJS.alert({title:"Error Adding User",message:"Please ensure the user does not already have access, then try again.",contextualColorName:"danger"})})}cityssm.openHtmlModal("userAdmin-addUser",{onshow(e){e.querySelector("#userAdd--userDomain").textContent=`${a}\\`},onshown(n,t){var a;e=t,bulmaJS.toggleHtmlClipped();const i=n.querySelector("#userAdd--userName");i.value="",i.focus(),null===(a=n.querySelector("form"))||void 0===a||a.addEventListener("submit",s)},onremoved(){bulmaJS.toggleHtmlClipped()}})}),p()})();