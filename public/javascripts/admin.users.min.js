"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),(()=>{var e;const s=exports.MonTY;let t=exports.users;delete exports.users;const n=exports.availablePermissionValues;delete exports.availablePermissionValues;const a=document.querySelector("#tbody--users");function i(e){var n;e.preventDefault();const a=e.currentTarget.closest("tr"),i=null!==(n=a.dataset.userName)&&void 0!==n?n:"";bulmaJS.confirm({title:"Delete User",message:`Are you sure you want to delete ${i}?<br />\n        Note that if this is temporary, revoking log in permissions would be easier to restore.`,messageIsHtml:!0,contextualColorName:"warning",okButton:{text:"Yes, Delete User",callbackFunction:function(){cityssm.postJSON(s.urlPrefix+"/admin/doDeleteUser",{userName:i},e=>{const s=e;s.success&&(bulmaJS.alert({message:"User deleted successfully.",contextualColorName:"success"}),a.remove()),t=s.users})}}})}function l(e){var n;e.preventDefault();const a=e.currentTarget,i=null!==(n=a.closest("tr").dataset.userName)&&void 0!==n?n:"";cityssm.postJSON(s.urlPrefix+"/admin/doUpdateUserCanLogin",{userName:i,canLogin:a.value},e=>{var s,n;const i=e;i.success?(a.closest(".control").querySelector(".icon").innerHTML=`<i class="fas ${"1"===a.value?"fa-check":"fa-times"}" aria-hidden="true"></i>`,null===(s=a.closest(".select"))||void 0===s||s.classList.remove("is-danger","is-success"),null===(n=a.closest(".select"))||void 0===n||n.classList.add("1"===a.value?"is-success":"is-danger")):bulmaJS.alert({title:"Error Updating Permission",message:"Please try again.",contextualColorName:"danger"}),t=i.users})}function o(e){var n;e.preventDefault();const a=e.currentTarget,i=null!==(n=a.closest("tr").dataset.userName)&&void 0!==n?n:"";cityssm.postJSON(s.urlPrefix+"/admin/doUpdateUserIsAdmin",{userName:i,isAdmin:a.value},e=>{var s,n;const i=e;i.success?(a.closest(".control").querySelector(".icon").innerHTML=`<i class="fas ${"1"===a.value?"fa-check":"fa-times"}" aria-hidden="true"></i>`,null===(s=a.closest(".select"))||void 0===s||s.classList.remove("is-danger","is-success"),null===(n=a.closest(".select"))||void 0===n||n.classList.add("1"===a.value?"is-success":"is-danger")):bulmaJS.alert({title:"Error Updating Permission",message:"Please try again.",contextualColorName:"danger"}),t=i.users})}function r(e){e.preventDefault();const t=e.currentTarget.closest("tr");cityssm.postJSON(s.urlPrefix+"/admin/doSetUserPermission",e.currentTarget,e=>{e.success?(bulmaJS.alert({message:"Permission updated successfully.",contextualColorName:"success"}),t.classList.remove("has-background-warning-light")):bulmaJS.alert({title:"Error Updating Permission",message:"Please try again.",contextualColorName:"danger"})})}function c(e){var s;null===(s=e.currentTarget.closest("tr"))||void 0===s||s.classList.add("has-background-warning-light")}function d(e){var t;let a;e.preventDefault();const i=null!==(t=e.currentTarget.closest("tr").dataset.userName)&&void 0!==t?t:"";cityssm.openHtmlModal("userAdmin-userPermissions",{onshow(e){cityssm.enableNavBlocker(),a=e,e.querySelector(".modal-card-title").textContent=i,function(){var e;const t=a.querySelector("tbody");for(const[s,a]of Object.entries(n)){const n=document.createElement("tr");n.dataset.permissionKey=s;let l="fa-cog";switch(s.slice(s.lastIndexOf(".")+1)){case"canView":l="fa-eye";break;case"canUpdate":l="fa-pencil-alt";break;case"canManage":l="fa-tools"}n.innerHTML=`<td class="is-vcentered">${s}</td>\n          <td>\n            <form>\n              <input name="userName" value="${i}" type="hidden" />\n              <input name="permissionKey" value="${s}" type="hidden" />\n              <div class="field has-addons">\n                <div class="control has-icons-left is-expanded">\n                  <div class="select is-fullwidth">\n                    <select name="permissionValue">\n                      <option value="">(Not Set)</option>\n                    </select>\n                  </div>\n                  <span class="icon is-left">\n                    <i class="fas ${l}" aria-hidden="true"></i>\n                  </span>\n                </div>\n                <div class="control">\n                  <button class="button is-success" type="submit" aria-label="Save Changes">\n                    <i class="fas fa-save" aria-hidden="true"></i>\n                  </button>\n                </div>\n              </div>\n            </form>\n          </td>`;const o=n.querySelector("select");for(const e of a)o.insertAdjacentHTML("beforeend",`<option value="${e}">${e}</option>`);o.addEventListener("change",c),null===(e=n.querySelector("form"))||void 0===e||e.addEventListener("submit",r),t.append(n)}cityssm.postJSON(s.urlPrefix+"/admin/doGetUserPermissions",{userName:i},e=>{var s,n;const a=e;let l=0;for(const[e,n]of Object.entries(a.userPermissions)){const a=t.querySelector(`tr[data-permission-key="${e}"]`);if(null===a){const a="form--permissionValue-"+(l+=1).toString();t.insertAdjacentHTML("beforeend",`<tr data-permission-key="${e}">\n                    <td class="is-vcentered is-italic">${e}</td>\n                    <td>\n                      <form id="${a}">\n                        <input name="userName" value="${i}" type="hidden" />\n                        <input name="permissionKey" value="${e}" type="hidden" />\n                        <div class="field has-addons">\n                          <div class="control is-expanded">\n                            <div class="select is-fullwidth">\n                              <select name="permissionValue">\n                                <option value="">(Not Set)</option>\n                                <option value="${n}" selected>${n}</option>\n                              </select>\n                            </div>\n                          </div>\n                          <div class="control">\n                            <button class="button is-success" type="submit">\n                              <i class="fas fa-save" aria-hidden="true"></i>\n                            </button>\n                          </div>\n                        </div>\n                      </form>\n                    </td>\n                  </tr>`),null===(s=t.querySelector(`#${a}`))||void 0===s||s.addEventListener("submit",r)}else{const e=a.querySelector("select");null===e.querySelector(`option[value="${n}"]`)&&e.insertAdjacentHTML("beforeend",`<option>${n}</option>`),e.value=n}}null===(n=t.closest("table"))||void 0===n||n.classList.remove("is-hidden")})}()},onshown(){bulmaJS.toggleHtmlClipped()},onremoved(){bulmaJS.toggleHtmlClipped(),cityssm.disableNavBlocker()}})}function u(){var e,s,n,r,c,u,m;a.innerHTML="";for(const v of t){const t=document.createElement("tr");t.dataset.userName=v.userName,t.innerHTML=`<td class="is-vcentered">\n          ${v.userName}\n            ${""===(null!==(e=v.employeeSurname)&&void 0!==e?e:"")?"":`<br />\n                  <span class="is-size-7 has-tooltip-right" data-tooltip="Employee">\n                  <i class="fas fa-hard-hat" aria-hidden="true"></i> ${null!==(s=v.employeeSurname)&&void 0!==s?s:""}, ${null!==(n=v.employeeGivenName)&&void 0!==n?n:""}\n                  </span>`}\n        </td>\n        <td>\n          <div class="control has-icons-left">\n            <div class="select ${v.canLogin?"is-success":"is-danger"}">\n              <select data-field="canLogin" aria-label="Can Login">\n                <option value="1" ${v.canLogin?" selected":""}>\n                  Can Log In\n                </option>\n                <option value="0" ${v.canLogin?"":" selected"}>\n                  Access Denied\n                </option>\n              </select>\n            </div>\n            <span class="icon is-small is-left">\n              <i class="fas ${v.canLogin?"fa-check":"fa-times"}" aria-hidden="true"></i>\n            </span>\n          </div>\n        </td>\n        <td>\n          <div class="control has-icons-left">\n            <div class="select ${v.isAdmin?"is-success":"is-danger"}">\n              <select data-field="isAdmin" aria-label="Is Administrator">\n                <option value="0" ${v.isAdmin?"":" selected"}>\n                  No Admin Access\n                </option>\n                <option value="1" ${v.isAdmin?" selected":""}>\n                  Administrator\n                </option>\n              </select>\n            </div>\n            <span class="icon is-small is-left">\n              <i class="fas ${v.isAdmin?"fa-check":"fa-times"}" aria-hidden="true"></i>\n            </span>\n          </div>\n        </td>\n        <td class="has-width-1 has-text-centered">\n          <button class="button is-user-permissions-button" type="button">\n            <span class="icon is-small"><i class="fas fa-th-list" aria-hidden="true"></i></span>\n            <span>Permissions</span>\n          </button>\n        </td>\n        <td class="has-width-1">\n          <button class="button is-danger is-delete-button" type="button" aria-label="Delete">\n            <span class="icon is-small"><i class="fas fa-trash" aria-hidden="true"></i></span>\n          </button>\n        </td>`,null===(r=t.querySelector('select[data-field="canLogin"]'))||void 0===r||r.addEventListener("change",l),null===(c=t.querySelector('select[data-field="isAdmin"]'))||void 0===c||c.addEventListener("change",o),null===(u=t.querySelector(".is-user-permissions-button"))||void 0===u||u.addEventListener("click",d),null===(m=t.querySelector(".is-delete-button"))||void 0===m||m.addEventListener("click",i),a.append(t)}}null===(e=document.querySelector(".is-add-user-button"))||void 0===e||e.addEventListener("click",()=>{let e;function n(n){n.preventDefault(),cityssm.postJSON(s.urlPrefix+"/admin/doAddUser",n.currentTarget,s=>{const n=s;n.success?(e(),bulmaJS.alert({message:"User added successfully.",contextualColorName:"success"}),t=n.users,u()):bulmaJS.alert({title:"Error Adding User",message:"Please ensure the user does not already have access, then try again.",contextualColorName:"danger"})})}cityssm.openHtmlModal("userAdmin-addUser",{onshown(s,t){var a;e=t,bulmaJS.toggleHtmlClipped();const i=s.querySelector("#userAdd--userName");i.value="",i.focus(),null===(a=s.querySelector("form"))||void 0===a||a.addEventListener("submit",n)},onremoved(){bulmaJS.toggleHtmlClipped()}})}),u()})();